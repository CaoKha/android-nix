# My Current Workflow (In Progress)

<!-- markdownlint-disable MD013 -->

## Prerequisites

- I've recently become interested in [Nix](https://nixos.org), so I'm using this opportunity to explore it.
- I followed this [link](https://zero-to-nix.com/start/install) to install Nix on my system.

```bash
curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix | sh -s -- install
```

- Note: I'm not using **Android Studio** or **Gradle** for this project as I'm not familiar with them.

## Step 1: Create a Reproducible Development Environment

- To start the development environment, navigate to the directory containing [flake.nix](../flake.nix) (the project root) and run:

```bash
nix develop
```

## Step 2: C++ Development

- Write C++ code in [checkupcomputing.h](../JNILib/src/main/cpp/checkupcomputing.h) and [checkupcomputing_test.cpp](../JNILib/src/main/cpp/checkupcomputing_test.cpp) for unit testing.
- Write C++ JNI code in [native-lib.cpp](../JNILib/src/main/cpp/native-lib.cpp) to port the C++ code to Android/Java.
- Create [CMakeLists.txt](../JNILib/CMakeLists.txt) to cross-compile [native-lib.cpp](../JNILib/src/main/cpp/native-lib.cpp) for both Android NDK and Linux.
- Ensure [CMakeLists.txt](../JNILib/CMakeLists.txt) also compiles [checkupcomputing_test.cpp](../JNILib/src/main/cpp/checkupcomputing_test.cpp) into an executable for Linux testing.

## Step 3: IDE Language Server Protocol (LSP) Setup

### Linux Development

- First, compile the C++ code for Linux using [CMakeLists.txt](../JNILib/CMakeLists.txt) to generate `libnative-lib.so`, and store it in the **build/cpp/linux/** folder:

```bash
mkdir -p build/cpp/android && mkdir -p build/cpp/linux
cd build/cpp/linux
cmake -G Ninja -DBUILD_TESTS=ON ../../../JNILib/
bear -- ninja -C . --verbose
```

Or use the shortcut:

```bash
make compile_cpp_linux
```

- Note: I used [CMake](https://cmake.org/), [Ninja](https://ninja-build.org/), and [Bear](https://github.com/rizsotto/Bear) to generate the compilation database.

- Then, create a [.clangd](../.clangd) file in the project root directory to reference the **compile_commands.json** generated by Bear:

```yml
CompileFlags:
  CompilationDatabase: ./build/cpp/linux
```

The IDE should now work properly.

- Note: I initially used `target_include_directories()` in [CMakeLists.txt](../JNILib/CMakeLists.txt) to include the JNI header files (`jni.h`), but **Ninja** didn't add the **-I** compile flags as expected. Therefore, I explicitly added the `-I` flags using `target_compile_options()`:

```cmake
# Explicitly add -I flags using target_compile_options
target_compile_options(native-lib PRIVATE
    -I${JAVA_HOME}/include
    -I${JAVA_HOME}/include/linux
)
```

### Android Development

- The cross-compilation setup for Android is similar to Linux:

```bash
mkdir -p build/cpp/android && mkdir -p build/cpp/linux
cd build/cpp/android
cmake -G Ninja -DCROSS_COMPILE_ANDROID=ON ../../../JNILib/
bear -- ninja -C . --verbose
```

Or use the shortcut:

```bash
make compile_cpp_android
```

- Update [.clangd](../.clangd) to reference **compile_commands.android.json** in **build/cpp/android/**:

```yml
CompileFlags:
  CompilationDatabase: ./build/cpp/android
```

## Step 4: C++ Unit Testing

- Compile [checkupcomputing_test.cpp](../JNILib/src/main/cpp/checkupcomputing_test.cpp) into an executable to test it on the local Linux machine (see [CMakeLists.txt](../JNILib/CMakeLists.txt) for details).

To run the test:

```bash
cd build/cpp/linux
cmake -G Ninja -DBUILD_TESTS=ON ../../../JNILib/
ninja -C .
./checkupcomputing_test
```

Or use the shortcut:

```bash
make test_cpp
```

Expected output:

```bash
❯ ./checkupcomputing_test
===========================================
All tests passed for N8kolibree11MouthZones8E
Test Summary:
- Total Zones Tested: 5
- Inputs:
  Zone: UpLeftExt8, Timestamp: 0, Duration: 1
  Zone: UpRightInt8, Timestamp: 1, Duration: 4
  Zone: UpLeftExt8, Timestamp: 5, Duration: 1
  Zone: LoLeftExt8, Timestamp: 6, Duration: 10
  Zone: LoRightExt8, Timestamp: 16, Duration: 5
  Zone: LoLeftExt8, Timestamp: 21, Duration: 3
  Zone: UpRightExt8, Timestamp: 24, Duration: 6
- Expected Outputs:
  Zone: UpLeftExt8, Coverage: 0.2
  Zone: UpRightInt8, Coverage: 0.4
  Zone: LoLeftExt8, Coverage: 1
  Zone: LoRightExt8, Coverage: 0.5
  Zone: UpRightExt8, Coverage: 0.6
- All zones have been correctly computed.
- Coverage values matched expected results with precision tolerance of 0.001.
===========================================

===========================================
All tests passed for N8kolibree12MouthZones12E
Test Summary:
- Total Zones Tested: 5
- Inputs:
  Zone: UpIncisorExt12, Timestamp: 0, Duration: 1.5
  Zone: UpMolarLeftInt12, Timestamp: 1.5, Duration: 4
  Zone: UpIncisorExt12, Timestamp: 5.5, Duration: 1
  Zone: LoIncisorExt12, Timestamp: 6.5, Duration: 2.3
  Zone: LoMolarRightExt12, Timestamp: 8.8, Duration: 4.3
  Zone: LoIncisorExt12, Timestamp: 13.1, Duration: 9
  Zone: UpMolarRightExt12, Timestamp: 22.1, Duration: 6
- Expected Outputs:
  Zone: UpIncisorExt12, Coverage: 0.25
  Zone: UpMolarLeftInt12, Coverage: 0.4
  Zone: LoIncisorExt12, Coverage: 1
  Zone: LoMolarRightExt12, Coverage: 0.43
  Zone: UpMolarRightExt12, Coverage: 0.6
- All zones have been correctly computed.
- Coverage values matched expected results with precision tolerance of 0.001.
===========================================

===========================================
All tests passed for N8kolibree12MouthZones16E
Test Summary:
- Total Zones Tested: 7
- Inputs:
  Zone: LoMolarLeftInt16, Timestamp: 0, Duration: 2.5
  Zone: UpIncisorInt16, Timestamp: 2.5, Duration: 3
  Zone: LoIncisorExt16, Timestamp: 5.5, Duration: 2
  Zone: UpMolarRightExt16, Timestamp: 7.5, Duration: 4
  Zone: LoMolarRightExt16, Timestamp: 11.5, Duration: 5
  Zone: UpIncisorExt16, Timestamp: 16.5, Duration: 3
  Zone: UpMolarLeftInt16, Timestamp: 19.5, Duration: 2
  Zone: LoIncisorExt16, Timestamp: 21.5, Duration: 4
  Zone: UpMolarRightExt16, Timestamp: 25.5, Duration: 3.5
- Expected Outputs:
  Zone: LoMolarLeftInt16, Coverage: 0.25
  Zone: UpIncisorInt16, Coverage: 0.3
  Zone: LoIncisorExt16, Coverage: 0.6
  Zone: UpMolarRightExt16, Coverage: 0.75
  Zone: LoMolarRightExt16, Coverage: 0.5
  Zone: UpIncisorExt16, Coverage: 0.3
  Zone: UpMolarLeftInt16, Coverage: 0.2
- All zones have been correctly computed.
- Coverage values matched expected results with precision tolerance of 0.001.
===========================================
```

## Step 5: Java Development

- Updated the Java folder path from **JNILib/src/main/java/test/kolibree/com/kolibreejnitest** to **JNILib/src/main/java/com/kolibree/**.

- Created multiple Java files:

```bash
JNILib/src/main/java/com/kolibree/
├── Brushing12.java
├── Brushing16.java
├── Brushing8.java
├── BrushingPass12.java
├── BrushingPass16.java
├── BrushingPass8.java
├── CheckupComputer.java
├── MouthZones12.java
├── MouthZones16.java
└── MouthZones8.java
```

The purpose of these files is to verify if Java can access native code from C++ (`libnative-lib.so`).

```java
// CheckupComputer.java
package com.kolibree;

import java.util.HashMap;

public class CheckupComputer {
  // Load the native library
  static {
    System.loadLibrary("native-lib"); // This loads libnative-lib.so
  }

  // Declare the native methods specific to each mouth zone configuration
  public native HashMap<MouthZones8, Float> computeCheckup8(Brushing8 brushing);
  public native HashMap<MouthZones12, Float> computeCheckup12(Brushing12 brushing);
  public native HashMap<MouthZones16, Float> computeCheckup16(Brushing16 brushing);
}
```

## Step 6: Java Unit Testing

- Updated the Java test folder path from **JNILib/src/test/java/test/kolibree/com/kolibreejnitest** to **JNILib/src/test/java/com/kolibree/**.

- Renamed **ExampleUnitTest.java** to **CheckupComputerUnitTest.java** and wrote the tests.

- Created a [Makefile](../Makefile) in the project root to simplify the build process.

To run the Java test, use:

```bash
make test_java
```

Expected output:

```bash
❯ make test_java
Downloading JUnit JAR...
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100  375k  100  375k    0     0  2487k      0 --:--:-- --:--:-- --:--:-- 2503k
JUnit JAR downloaded successfully.
Downloading Hamcrest JAR...
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100 45024  100 45024    0     0   433k      0 --:--:-- --:--:-- --:--:--  435k
Hamcrest JAR downloaded successfully.
Compiling C++ code for Linux...
cd build/cpp/linux && cmake /home/nck13/Documents/develop/github/caokhacpp/JNILib -G Ninja -DBUILD_TESTS=ON
-- Configuring for native Linux build
-- The C compiler identification is GNU 12.2.0
-- The CXX compiler identification is GNU 12.2.0
-- Detecting C compiler ABI info
-- Detecting C compiler ABI info - done
-- Check for working C compiler: /nix/store/h5003wsy3qqimqvrkn3bc5mwq4hhidag-gcc-wrapper-12.2.0/bin/gcc - skipped
-- Detecting C compile features
-- Detecting C compile features - done
-- Detecting CXX compiler ABI info
-- Detecting CXX compiler ABI info - done
-- Check for working CXX compiler: /nix/store/h5003wsy3qqimqvrkn3bc5mwq4hhidag-gcc-wrapper-12.2.0/bin/g++ - skipped
-- Detecting CXX compile features
-- Detecting CXX compile features - done
-- Configuring done
-- Generating done
-- Build files have been written to: /home/nck13/Documents/develop/github/caokhacpp/build/cpp/linux
cd build/cpp/linux && ninja
[6/6] Linking CXX executable checkupcomputing_test
C++ compilation completed.
Copying native library to build/java/libs...
Native library copied successfully.
Compiling main Java classes...
Main Java classes compiled successfully.
Compiling test Java classes...
Test Java classes compiled successfully.
Running Java unit tests...
JUnit version 4.13.2
...
Time: 0.009

OK (3 tests)

Java unit tests executed successfully.

```

## Step 7: Makefile Setup

- The [Makefile](../Makefile) in the project root provides shortcuts to build and test the project with a single command.

## Step 8: Android Emulator Testing (WIP)
