# My Workflow

<!-- markdownlint-disable MD013 -->

Note: If you just want to test the code skip to the [TLDR section](#summarize-tldr)

## Prerequisites

- I've recently become interested in [Nix](https://nixos.org), so I'm using this opportunity to explore it.
- I followed this [link](https://zero-to-nix.com/start/install) to install Nix on my system.

```bash
curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix | sh -s -- install
```

- Note: I'm not using **Android Studio** IDE for this project as I'm not familiar with them.

## Step 1: Create a Reproducible Development Environment

- To start the development environment, navigate to the directory containing [flake.nix](../flake.nix) (the project root) and run:

```bash
nix develop
```

- Note: By default, the android_abi is set to "x86_64",
  you can change it to "amr64_v8a" by using this command:

```bash
nix develop .#devShells.x86_64-linux.arm64-v8a
```

## Step 2: C++ Development

- Write C++ code in [checkupcomputing.h](../JNILib/src/main/cpp/checkupcomputing.h) and [checkupcomputing_test.cpp](../JNILib/src/main/cpp/checkupcomputing_test.cpp) for unit testing.
- Write C++ JNI code in [native-lib.cpp](../JNILib/src/main/cpp/native-lib.cpp) to port the C++ code to Android/Java.
- Create [CMakeLists.txt](../JNILib/CMakeLists.txt) to cross-compile [native-lib.cpp](../JNILib/src/main/cpp/native-lib.cpp) for both Android NDK and Linux.
- Ensure [CMakeLists.txt](../JNILib/CMakeLists.txt) also compiles [checkupcomputing_test.cpp](../JNILib/src/main/cpp/checkupcomputing_test.cpp) into an executable for Linux testing.

## Step 3: IDE Language Server Protocol (LSP) Setup

### Linux Development

- First, compile the C++ code for Linux using [CMakeLists.txt](../JNILib/CMakeLists.txt) to generate `libnative-lib.so`, and store it in the **build/cpp/linux/** folder:

```bash
mkdir -p build/cpp/android && mkdir -p build/cpp/linux
cd build/cpp/linux
cmake -G Ninja -DBUILD_TESTS=ON ../../../JNILib/
bear -- ninja -C . --verbose
```

Or use the shortcut:

```bash
make compile_cpp_linux
```

- Note: I used [CMake](https://cmake.org/), [Ninja](https://ninja-build.org/), and [Bear](https://github.com/rizsotto/Bear) to generate the compilation database.

- Then, create a [.clangd](../.clangd) file in the project root directory to reference the **compile_commands.json** generated by Bear:

```yml
CompileFlags:
  CompilationDatabase: ./build/cpp/linux
```

The IDE should now work properly.

- Note: I initially used `target_include_directories()` in [CMakeLists.txt](../JNILib/CMakeLists.txt) to include the JNI header files (`jni.h`), but **Ninja** didn't add the **-I** compile flags as expected. Therefore, I explicitly added the `-I` flags using `target_compile_options()`:

```cmake
# Explicitly add -I flags using target_compile_options
target_compile_options(native-lib PRIVATE
    -I${JAVA_HOME}/include
    -I${JAVA_HOME}/include/linux
)
```

### Android Development

- The cross-compilation setup for Android is similar to Linux:

```bash
mkdir -p build/cpp/android && mkdir -p build/cpp/linux
cd build/cpp/android
cmake -G Ninja -DCROSS_COMPILE_ANDROID=ON ../../../JNILib/
bear -- ninja -C . --verbose
```

Or use the shortcut:

```bash
make compile_cpp_android
```

- Update [.clangd](../.clangd) to reference **compile_commands.android.json** in **build/cpp/android/${ANDROID_ABI}**:

```yml
CompileFlags:
  CompilationDatabase: ./build/cpp/android/x86_64
```

## Step 4: C++ Unit Testing

- Compile [checkupcomputing_test.cpp](../JNILib/src/main/cpp/checkupcomputing_test.cpp) into an executable to test it on the local Linux machine (see [CMakeLists.txt](../JNILib/CMakeLists.txt) for details).

To run the test:

```bash
cd build/cpp/linux
cmake -G Ninja -DBUILD_TESTS=ON ../../../JNILib/
ninja -C .
./checkupcomputing_test
```

Or use the shortcut:

```bash
make test_cpp
```

Expected output:

```bash
❯ ./checkupcomputing_test
===========================================
All tests passed for N8kolibree11MouthZones8E
Test Summary:
- Total Zones Tested: 5
- Inputs:
  Zone: UpLeftExt8, Timestamp: 0, Duration: 1
  Zone: UpRightInt8, Timestamp: 1, Duration: 4
  Zone: UpLeftExt8, Timestamp: 5, Duration: 1
  Zone: LoLeftExt8, Timestamp: 6, Duration: 10
  Zone: LoRightExt8, Timestamp: 16, Duration: 5
  Zone: LoLeftExt8, Timestamp: 21, Duration: 3
  Zone: UpRightExt8, Timestamp: 24, Duration: 6
- Expected Outputs:
  Zone: UpLeftExt8, Coverage: 0.2
  Zone: UpRightInt8, Coverage: 0.4
  Zone: LoLeftExt8, Coverage: 1
  Zone: LoRightExt8, Coverage: 0.5
  Zone: UpRightExt8, Coverage: 0.6
- All zones have been correctly computed.
- Coverage values matched expected results with precision tolerance of 0.001.
===========================================

===========================================
All tests passed for N8kolibree12MouthZones12E
Test Summary:
- Total Zones Tested: 5
- Inputs:
  Zone: UpIncisorExt12, Timestamp: 0, Duration: 1.5
  Zone: UpMolarLeftInt12, Timestamp: 1.5, Duration: 4
  Zone: UpIncisorExt12, Timestamp: 5.5, Duration: 1
  Zone: LoIncisorExt12, Timestamp: 6.5, Duration: 2.3
  Zone: LoMolarRightExt12, Timestamp: 8.8, Duration: 4.3
  Zone: LoIncisorExt12, Timestamp: 13.1, Duration: 9
  Zone: UpMolarRightExt12, Timestamp: 22.1, Duration: 6
- Expected Outputs:
  Zone: UpIncisorExt12, Coverage: 0.25
  Zone: UpMolarLeftInt12, Coverage: 0.4
  Zone: LoIncisorExt12, Coverage: 1
  Zone: LoMolarRightExt12, Coverage: 0.43
  Zone: UpMolarRightExt12, Coverage: 0.6
- All zones have been correctly computed.
- Coverage values matched expected results with precision tolerance of 0.001.
===========================================

===========================================
All tests passed for N8kolibree12MouthZones16E
Test Summary:
- Total Zones Tested: 7
- Inputs:
  Zone: LoMolarLeftInt16, Timestamp: 0, Duration: 2.5
  Zone: UpIncisorInt16, Timestamp: 2.5, Duration: 3
  Zone: LoIncisorExt16, Timestamp: 5.5, Duration: 2
  Zone: UpMolarRightExt16, Timestamp: 7.5, Duration: 4
  Zone: LoMolarRightExt16, Timestamp: 11.5, Duration: 5
  Zone: UpIncisorExt16, Timestamp: 16.5, Duration: 3
  Zone: UpMolarLeftInt16, Timestamp: 19.5, Duration: 2
  Zone: LoIncisorExt16, Timestamp: 21.5, Duration: 4
  Zone: UpMolarRightExt16, Timestamp: 25.5, Duration: 3.5
- Expected Outputs:
  Zone: LoMolarLeftInt16, Coverage: 0.25
  Zone: UpIncisorInt16, Coverage: 0.3
  Zone: LoIncisorExt16, Coverage: 0.6
  Zone: UpMolarRightExt16, Coverage: 0.75
  Zone: LoMolarRightExt16, Coverage: 0.5
  Zone: UpIncisorExt16, Coverage: 0.3
  Zone: UpMolarLeftInt16, Coverage: 0.2
- All zones have been correctly computed.
- Coverage values matched expected results with precision tolerance of 0.001.
===========================================
```

## Step 5: Java Development

- Updated the Java folder path from **JNILib/src/main/java/test/kolibree/com/kolibreejnitest** to **JNILib/src/main/java/com/kolibree/**.

- Created multiple Java files:

```bash
JNILib/src/main/java/com/kolibree/
├── Brushing12.java
├── Brushing16.java
├── Brushing8.java
├── BrushingPass12.java
├── BrushingPass16.java
├── BrushingPass8.java
├── CheckupComputer.java
├── MouthZones12.java
├── MouthZones16.java
└── MouthZones8.java
```

The purpose of these files is to verify if Java can access native code from C++ (`libnative-lib.so`).

```java
// CheckupComputer.java
package com.kolibree;

import java.util.HashMap;

public class CheckupComputer {
  // Load the native library
  static {
    System.loadLibrary("native-lib"); // This loads libnative-lib.so
  }

  // Declare the native methods specific to each mouth zone configuration
  public native HashMap<MouthZones8, Float> computeCheckup8(Brushing8 brushing);
  public native HashMap<MouthZones12, Float> computeCheckup12(Brushing12 brushing);
  public native HashMap<MouthZones16, Float> computeCheckup16(Brushing16 brushing);
}
```

## Step 6: Java Unit Testing

- Updated the Java test folder path from **JNILib/src/test/java/test/kolibree/com/kolibreejnitest** to **JNILib/src/test/java/com/kolibree/**.

- Renamed **ExampleUnitTest.java** to **CheckupComputerUnitTest.java** and wrote the tests.

- Created a [Makefile](../Makefile) in the project root to simplify the build process.

To run the Java test, use:

```bash
make test_java
```

Expected output:

```bash
❯ make test_java
Downloading JUnit JAR...
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100  375k  100  375k    0     0  2487k      0 --:--:-- --:--:-- --:--:-- 2503k
JUnit JAR downloaded successfully.
Downloading Hamcrest JAR...
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100 45024  100 45024    0     0   433k      0 --:--:-- --:--:-- --:--:--  435k
Hamcrest JAR downloaded successfully.
Compiling C++ code for Linux...
cd build/cpp/linux && cmake /home/nck13/Documents/develop/github/caokhacpp/JNILib -G Ninja -DBUILD_TESTS=ON
-- Configuring for native Linux build
-- The C compiler identification is GNU 12.2.0
-- The CXX compiler identification is GNU 12.2.0
-- Detecting C compiler ABI info
-- Detecting C compiler ABI info - done
-- Check for working C compiler: /nix/store/h5003wsy3qqimqvrkn3bc5mwq4hhidag-gcc-wrapper-12.2.0/bin/gcc - skipped
-- Detecting C compile features
-- Detecting C compile features - done
-- Detecting CXX compiler ABI info
-- Detecting CXX compiler ABI info - done
-- Check for working CXX compiler: /nix/store/h5003wsy3qqimqvrkn3bc5mwq4hhidag-gcc-wrapper-12.2.0/bin/g++ - skipped
-- Detecting CXX compile features
-- Detecting CXX compile features - done
-- Configuring done
-- Generating done
-- Build files have been written to: /home/nck13/Documents/develop/github/caokhacpp/build/cpp/linux
cd build/cpp/linux && ninja
[6/6] Linking CXX executable checkupcomputing_test
C++ compilation completed.
Copying native library to build/java/libs...
Native library copied successfully.
Compiling main Java classes...
Main Java classes compiled successfully.
Compiling test Java classes...
Test Java classes compiled successfully.
Running Java unit tests...
JUnit version 4.13.2
...
Time: 0.009

OK (3 tests)

Java unit tests executed successfully.

```

## Step 7: Makefile Setup

- The [Makefile](../Makefile) in the project root provides shortcuts to build and test the project with a single command.

## Step 8: Android Emulator Testing

- At the start of this section, I struggled to get the gradlew script to work properly (due to version compatibility issues),
  I then brute forced using the command line to build the test **apk** and failed. Here are the attempts I made:

```bash
❯ make run_android_instrumented_tests
Stopping emulator if running...
Emulator found: emulator-5554, stopping...
OK: killing emulator, bye bye
OK
INFO    | Wait for emulator (pid 683474) 20 seconds to shutdown gracefully before kill;you can set environment variable ANDROID_EMULATOR_WAIT_TIME_BEFORE_KILL(in seconds) to change the default value (20 seconds)
INFO    | Saving with gfxstream=1
ERROR   | stop: Not implemented
Emulator emulator-5554 stopped successfully.
Checking if AVD named pixel_emu exists...
AVD pixel_emu already exists.
AVD pixel_emu created successfully.
Starting emulator pixel_emu...
INFO    | Storing crashdata in: /tmp/android-nck13/emu-crash-35.1.4.db, detection is enabled for process: 685058
INFO    | Android emulator version 35.1.4.0 (build_id 11672324) (CL:N/A)
INFO    | Found systemPath /nix/store/wllkjxvkbs3hgijjkaxyvydjvxi7qhrl-androidsdk/libexec/android-sdk/system-images/android-30/google_apis_playstore/x86_64/
INFO    | Storing crashdata in: /tmp/android-nck13/emu-crash-35.1.4.db, detection is enabled for process: 685058
INFO    | Duplicate loglines will be removed, if you wish to see each individual line launch with the -log-nofilter flag.
WARNING | Please update the emulator to one that supports the feature(s): Vulkan
INFO    | Increasing RAM size to 2048MB
WARNING | FeatureControl is requesting a non existing feature.
WARNING | Your GPU drivers may have a bug. Switching to software rendering.
library_mode swangle_indirect gpu mode swangle_indirect
INFO    | Initializing hardware OpenGLES emulation support
android_startOpenglesRenderer: gpu infoI1111 00:21:48.934829  685058 HealthMonitor.cpp:279] HealthMonitor disabled.
cannot add library /nix/store/m56hikiq94wjyb9wgbsy9q32vcvp7mmw-android-sdk-emulator-35.1.4/libexec/android-sdk/emulator/qemu/linux-x86_64/lib64/vulkan/libvulkan.so: failed
cannot add library /nix/store/m56hikiq94wjyb9wgbsy9q32vcvp7mmw-android-sdk-emulator-35.1.4/libexec/android-sdk/emulator/qemu/linux-x86_64/lib64/vulkan/libvulkan.so.1: failed
added library /nix/store/m56hikiq94wjyb9wgbsy9q32vcvp7mmw-android-sdk-emulator-35.1.4/libexec/android-sdk/emulator/lib64/vulkan/libvulkan.so
createGlobalVkEmulation:997 Selecting Vulkan device: SwiftShader Device (Subzero)
initialize: Supports id properties, got a vulkan device UUID
I1111 00:21:49.019640  685058 VkCommonOperations.cpp:1287] Initializing VkEmulation features:
I1111 00:21:49.019659  685058 VkCommonOperations.cpp:1288]     glInteropSupported: false
I1111 00:21:49.019663  685058 VkCommonOperations.cpp:1289]     useDeferredCommands: true
I1111 00:21:49.019666  685058 VkCommonOperations.cpp:1291]     createResourceWithRequirements: true
I1111 00:21:49.019668  685058 VkCommonOperations.cpp:1292]     useVulkanComposition: false
I1111 00:21:49.019671  685058 VkCommonOperations.cpp:1293]     useVulkanNativeSwapchain: false
I1111 00:21:49.019673  685058 VkCommonOperations.cpp:1294]     enable guestRenderDoc: false
I1111 00:21:49.019675  685058 VkCommonOperations.cpp:1295]     ASTC LDR emulation mode: 2
I1111 00:21:49.019678  685058 VkCommonOperations.cpp:1296]     enable ETC2 emulation: true
I1111 00:21:49.019680  685058 VkCommonOperations.cpp:1297]     enable Ycbcr emulation: false
I1111 00:21:49.019682  685058 VkCommonOperations.cpp:1298]     guestUsesAngle: false
I1111 00:21:49.019685  685058 VkCommonOperations.cpp:1299]     useDedicatedAllocations: false
I1111 00:21:49.021065  685058 FrameBuffer.cpp:505] Graphics Adapter Vendor Google (Google Inc.)
I1111 00:21:49.021084  685058 FrameBuffer.cpp:506] Graphics Adapter Android Emulator OpenGL ES Translator (Google SwiftShader)
I1111 00:21:49.021088  685058 FrameBuffer.cpp:507] Graphics API Version OpenGL ES 3.0 (OpenGL ES 3.0 SwiftShader 4.0.0.1)
I1111 00:21:49.021091  685058 FrameBuffer.cpp:508] Graphics API Extensions GL_OES_EGL_sync GL_OES_EGL_image GL_OES_EGL_image_external GL_OES_depth24 GL_OES_depth32 GL_OES_element_index_uint GL_OES_texture_float GL_OES_texture_float_linear GL_OES_compressed_paletted_texture GL_OES_compressed_ETC1_RGB8_texture GL_OES_depth_texture GL_OES_texture_half_float GL_OES_texture_half_float_linear GL_OES_packed_depth_stencil GL_OES_vertex_half_float GL_OES_standard_derivatives GL_OES_texture_npot GL_OES_rgb8_rgba8 GL_EXT_color_buffer_float GL_EXT_color_buffer_half_float GL_EXT_texture_format_BGRA8888 GL_APPLE_texture_format_BGRA8888
I1111 00:21:49.021101  685058 FrameBuffer.cpp:509] Graphics Device Extensions N/A
pulseaudio: Failed to initialize PA contextCould not init `pa' audio driver
INFO    | Monitoring duration of emulator setup.
WARNING | The emulator now requires a signed jwt token for gRPC access! Use the -grpc flag if you really want an open unprotected grpc port
INFO    | Using security allow list from: /nix/store/m56hikiq94wjyb9wgbsy9q32vcvp7mmw-android-sdk-emulator-35.1.4/libexec/android-sdk/emulator/lib/emulator_access.json
WARNING | *** Basic token auth should only be used by android-studio ***
INFO    | The active JSON Web Key Sets can be found here: /run/user/1000/avd/running/685058/jwks/1fd66311-2caf-4ec2-952a-a5759a0389b7/active.jwk
INFO    | Scanning /run/user/1000/avd/running/685058/jwks/1fd66311-2caf-4ec2-952a-a5759a0389b7 for jwk keys.
INFO    | Started GRPC server at 127.0.0.1:8554, security: Local, auth: +token
INFO    | Advertising in: /run/user/1000/avd/running/pid_685058.ini
I1111 00:21:49.138928  685118 FrameBuffer.cpp:2879] Setting display: 0 configuration to: 1080x1920, dpi: 420x420
I1111 00:21:49.138956  685118 FrameBuffer.cpp:2892] setDisplayActiveConfig 0
##############################################################################
##                        WARNING - ACTION REQUIRED                         ##
##  Consider using the '-metrics-collection' flag to help improve the       ##
##  emulator by sending anonymized usage data. Or use the '-no-metrics'     ##
##  flag to bypass this warning and turn off the metrics collection.        ##
##  In a future release this warning will turn into a one-time blocking     ##
##  prompt to ask for explicit user input regarding metrics collection.     ##
##                                                                          ##
##  Please see '-help-metrics-collection' for more details. You can use     ##
##  '-metrics-to-file' or '-metrics-to-console' flags to see what type of   ##
##  data is being collected by emulator as part of usage statistics.        ##
##############################################################################
INFO    | Cold boot: requested by the user
WARNING | Cold boot: requested by the user
Generating debug keystore if it doesn't exist...
INFO    | Boot completed in 30767 ms
INFO    | Increasing screen off timeout, logcat buffer size to 2M.
Generating 2,048 bit RSA key pair and self-signed certificate (SHA256withRSA) with a validity of 10,000 days
        for: CN=Default Debug, OU=Development, O=Company, L=City, ST=State, C=US
[Storing /home/nck13/Documents/develop/github/caokhacpp/build/java/debug_keystore/debug.keystore]
Debug keystore generated successfully.
Downloading JUnit JAR...
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100  375k  100  375k    0     0  2126k      0 --:--:-- --:--:-- --:--:-- 2121k
JUnit JAR downloaded successfully.
Downloading Hamcrest JAR...
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100 45024  100 45024    0     0   399k      0 --:--:-- --:--:-- --:--:--  403k
Hamcrest JAR downloaded successfully.
Downloading AndroidX Test Runner AAR...
AndroidX Test Runner AAR downloaded successfully.
Extracting classes.jar from AndroidX Test Runner AAR...
classes.jar extracted and renamed to build/java/libs/androidx-test-runner-1.6.2.jar
Downloading AndroidX Test Core AAR...
AndroidX Test Core AAR downloaded successfully.
Extracting classes.jar from AndroidX Test Core AAR...
classes.jar extracted and renamed to build/java/libs/androidx-test-core-1.6.1.jar
Downloading AndroidX Test Ext JUnit AAR...
AndroidX Test Ext JUnit AAR downloaded successfully.
Extracting classes.jar from AndroidX Test Ext JUnit AAR...
classes.jar extracted and renamed to build/java/libs/androidx-test-ext-junit-1.2.1.jar
Downloading AndroidX Test Expresso Core AAR...
AndroidX Test Expresso Core AAR downloaded successfully.
Extracting classes.jar from AndroidX Test Expresso Core AAR...
classes.jar extracted and renamed to build/java/libs/androidx-test-espresso-core-3.6.1.jar
Downloading Androidx Annotation JAR...
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100   294  100   294    0     0   3099      0 --:--:-- --:--:-- --:--:--  3127
100 11586  100 11586    0     0  54664      0 --:--:-- --:--:-- --:--:-- 54664
Androidx Annotation JAR downloaded successfully.
Compiling C++ code for Android...
cd build/cpp/android/x86_64 && cmake /home/nck13/Documents/develop/github/caokhacpp/JNILib -G Ninja -DCROSS_COMPILE_ANDROID=ON
-- Configuring for Android cross-compilation
-- The C compiler identification is Clang 17.0.2
-- The CXX compiler identification is Clang 17.0.2
-- Detecting C compiler ABI info
-- Detecting C compiler ABI info - done
-- Check for working C compiler: /nix/store/wllkjxvkbs3hgijjkaxyvydjvxi7qhrl-androidsdk/libexec/android-sdk/ndk-bundle/toolchains/llvm/prebuilt/linux-x86_64/bin/clang - skipped
-- Detecting C compile features
-- Detecting C compile features - done
-- Detecting CXX compiler ABI info
-- Detecting CXX compiler ABI info - done
-- Check for working CXX compiler: /nix/store/wllkjxvkbs3hgijjkaxyvydjvxi7qhrl-androidsdk/libexec/android-sdk/ndk-bundle/toolchains/llvm/prebuilt/linux-x86_64/bin/clang++ - skipped
-- Detecting CXX compile features
-- Detecting CXX compile features - done
-- log library found: /nix/store/wllkjxvkbs3hgijjkaxyvydjvxi7qhrl-androidsdk/libexec/android-sdk/ndk-bundle/toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/lib/x86_64-linux-android/30/liblog.so
-- Configuring done (0.5s)
-- Generating done (0.0s)
-- Build files have been written to: /home/nck13/Documents/develop/github/caokhacpp/build/cpp/android/x86_64
cd build/cpp/android/x86_64 && ninja
[3/3] Linking CXX shared library libnative-lib.so
C++ compilation for Android completed.
Checking and copying native library for Android to JNILib/src/main/jniLibs...
Native library copied successfully to JNILib/src/main/jniLibs/x86_64.
Compiling main Java classes...
Main Java classes compiled successfully.
Compiling Android instrumented test classes...
Android instrumented test classes compiled successfully.
Converting Android test classes to Dex format...
Dex conversion completed.
Assembling Android Test APK...
# Copy AndroidManifest.xml
# Copy classes.dex
# Copy the compiled test classes into the APK
# Copy native library to the correct ABI directory
# Use aapt to package APK with AndroidManifest.xml and compiled classes
# Add classes.dex, test classes, and native libraries using zip
Adding classes.dex, test classes, and libnative-lib.so to APK...
  adding: build/java/apk/android_test/lib/x86_64/libnative-lib.so (deflated 75%)
Android Test APK assembled successfully.
Signing Android Test APK...
Android Test APK signed successfully.
Uninstalling any existing version of the app from the emulator...
Failure [DELETE_FAILED_INTERNAL_ERROR]
No existing app to uninstall
Installing Android Test APK on the emulator...
Performing Streamed Install
adb: failed to install build/java/apk/android_test/base.apk: Failure [INSTALL_FAILED_INVALID_APK: Scanning Failed.: Package /data/app/~~0PpWojJn36ngsT57M8gkxg==/com.kolibree-TfCktNxzA2Ko0fjZGRXhoQ==/base.apk code is missing]
Failed to install APK
make: *** [Makefile:345: install_android_test_apk] Error 1
```

- Later, I decided regenerating all gradlew files from scratch

```bash
make generate_gradle_wrapper
```

and suddenly, the test was built succeeded and ran perfectly! To run the test, use:

```bash
make test_android
```

- Expected result:

```bash
Starting 3 tests on pixel_emu(AVD) - 11

com.kolibree.InstrumentedTest > testComputeCheckup8[pixel_emu(AVD) - 11] SUCCESS

com.kolibree.InstrumentedTest > testComputeCheckup12[pixel_emu(AVD) - 11] SUCCESS

com.kolibree.InstrumentedTest > testComputeCheckup16[pixel_emu(AVD) - 11] SUCCESS

INFO: Stop logcat streaming.
Finished 3 tests on pixel_emu(AVD) - 11
[XmlResultReporter]: XML test result file generated at /home/nck13/Documents/develop/github/caokhacpp/JNILib/build/outputs/androidTest-results/connected/debug/TEST-pixel_emu(AVD) - 11-_JNILib-.xml. Total tests 3, passed 3,
INFO: Execute com.kolibree.InstrumentedTest.testComputeCheckup8: PASSED
INFO: Execute com.kolibree.InstrumentedTest.testComputeCheckup12: PASSED
INFO: Execute com.kolibree.InstrumentedTest.testComputeCheckup16: PASSED
Resolve mutations for :JNILib:connectedAndroidTest (Thread[Execution worker Thread 7,5,main]) started.
:JNILib:connectedAndroidTest (Thread[Execution worker Thread 7,5,main]) started.

> Task :JNILib:connectedAndroidTest
Skipping task ':JNILib:connectedAndroidTest' as it has no actions.

BUILD SUCCESSFUL in 23s
45 actionable tasks: 1 executed, 44 up-to-date
```

## Step 9: Add CI Pipeline

- [gitlab-ci](../.gitlab-ci.yml)

## Step 10: Cleanup

- First, we have to turn off the emulator:

```bash
make stop_emulator
```

- Then, clean up the build directory:

```bash
make clean
```

## Summarize (TLDR)

- First download and enable nix development environment:

```bash
curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix | sh -s -- install
```

```bash
nix develop
```

- Run the Cpp unit tests in Linux:

```bash
make test_cpp
```

- Run the Java unit tests in Linux:

```bash
make test_java
```

- Run the Android instrumented tests in Android emulator:

```bash
make test_android
```
